C51 COMPILER V9.52.0.0   DUST                                                              10/03/2019 11:44:44 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE DUST
OBJECT MODULE PLACED IN .\obj\dust.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\dust.c BROWSE INCDIR(.\inc;.\lib) DEBUG OBJECTEXTEND PRINT(.\list\dust.
                    -lst) TABS(2) OBJECT(.\obj\dust.obj)

line level    source

   1          
   2          /*
   3           *  dust.c
   4           *  Kit Shaw
   5           *  2019/10/01
   6           */
   7          #include "SC92F844X_C.h"
   8          #include "data_type.h"
   9          #include "dust.h"
  10          
  11          unsigned short dust_adc_value[10];
  12          unsigned short dust_adc_mean;       //平均值
  13          unsigned char dust_ok_flag;            //adc转换完成标志
  14          unsigned char dust_index = 0;
  15          //unsigned char dust_size ;
  16          //AD15 P43, 第19脚
  17          void dust_init(void)
  18          { 
  19   1        P5CON |= ((1<<4)| (1<<3)); //P54, P53输出
  20   1        //ADCCFG1 |= 1<<7; //AIN15位acd输入口
  21   1        adc_init(15);
  22   1        dust_adc_mean = 0;
  23   1      }
  24          
  25          unsigned short read_dust_adc_value(void)
  26          {
  27   1        return dust_adc_mean;
  28   1      }
  29          
  30          void dust_adc_mean_value(void)
  31          {
  32   1        unsigned char i;
  33   1        unsigned short sum;
  34   1        sum = 0;
  35   1        for(i = 0; i<DUST_SIZE; i++)
  36   1        {
  37   2          sum += dust_adc_value[i];
  38   2        }
  39   1        
  40   1        dust_adc_mean /= i;
  41   1      }
  42          
  43          
  44          void dust_task(void)
  45          //1ms调用一次
  46          {
  47   1          if(1 == dust_ok_flag)
  48   1          {
  49   2            dust_ok_flag = 0;
  50   2            dust_adc_value[dust_index] = (ADCVH<<4)+(ADCVL>>4);
  51   2            if(++dust_index > DUST_SIZE)
  52   2            {
  53   3              dust_adc_mean_value();
  54   3              dust_index = 0;
C51 COMPILER V9.52.0.0   DUST                                                              10/03/2019 11:44:44 PAGE 2   

  55   3            }
  56   2          }
  57   1      }
  58          
  59          /*****************************************************
  60          *????:void ADC_Init(uint Channel)
  61          *????:ADC???
  62          *????:void
  63          *????:Channel
  64          *****************************************************/
  65          void adc_init(unsigned int channel)
  66          {
  67   1        ADCCON = 0X80|channel;    //??ADC,ADC?????2M ,??Channel?ADC???
  68   1        if(channel<8)
  69   1        {
  70   2          ADCCFG0 = 1<<channel;   //??Channel?????
  71   2        }
  72   1        else
  73   1        {
  74   2          ADCCFG1 = 1<<(channel-8);   //??Channel?????
  75   2        }
  76   1        //OP_CTM1 &= ~(1<<7); //参考电压为VDD = 5V
  77   1        
  78   1        IE = 0X40;        //??ADC??
  79   1      }
  80          
  81          void adc_start(void)
  82          //启动ADC转换
  83          {
  84   1        ADCCON |= 0X40;   //启动AD转换
  85   1      }
  86          
  87          
  88          void ADC_Interrupt(void) interrupt 6
  89          {
  90   1        ADCCON &= ~(0X20);  //清中断标准位
  91   1        ADCCON &= ~0X40;   //停止AD转换
  92   1        dust_ok_flag = 1;
  93   1      }
  94          
  95          
  96          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    179    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     24    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
