C51 COMPILER V9.52.0.0   FILTER                                                            10/19/2019 22:24:25 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE FILTER
OBJECT MODULE PLACED IN .\obj\filter.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\filter.c BROWSE INCDIR(.\inc;.\lib) DEBUG OBJECTEXTEND PRINT(.\list\fil
                    -ter.lst) TABS(2) OBJECT(.\obj\filter.obj)

line level    source

   1          
   2          /*
   3           * filter.c
   4           * Kit Shaw
   5           * 2019.10.5
   6           */
   7           
   8          #include "filter.h"
   9          #include "eeprom.h"
  10          #include "led.h"
  11          #include "data_type.h"
  12          #include "fan.h"
  13          #include "sc92f844x_c.h"
  14          //#include "IAP.h"
  15          
  16          
  17          volatile unsigned long filter_time;  //滤网寿命存储在eerom的12h(高位), 13h, 14h, 15h(地位)
  18          unsigned char filter_out_time_flag; //滤网过期标志, 1,outtime
  19           
  20          void filter_init(void)
  21          {
  22   1        //read_filter_time();
  23   1        filter_time = read_filter_time();
  24   1        if(filter_time >= FILTER_TOTAL_TIME)filter_out_time_flag = 1;
  25   1      }
  26          
  27          void filter_task(void)
  28          //100ms调用一次
  29          {
  30   1        
  31   1        static unsigned char count_1s, count2;
  32   1        if(read_power_status() == POWER_OFF_STATUS) return;
  33   1        if(1 == filter_out_time_flag )
  34   1        {
  35   2          if(++count2 >= 3)
  36   2          {
  37   3            count2 = 0;
  38   3      //      led_filter_out_time();
  39   3          }
  40   2        }
  41   1        if(++count_1s >= 10) 
  42   1        {
  43   2          count_1s = 0;
  44   2          if(filter_time >= FILTER_TOTAL_TIME)
  45   2          {
  46   3            if(0 == filter_out_time_flag)write_filter_time();  //到期要写入一次
  47   3            filter_out_time_flag = 1;
  48   3          }
  49   2          else {filter_time++; }
  50   2          
  51   2        }
  52   1        led_display_filter_out(filter_out_time_flag);
  53   1      }
  54          
C51 COMPILER V9.52.0.0   FILTER                                                            10/19/2019 22:24:25 PAGE 2   

  55          void write_filter_time(void)
  56          {
  57   1        unsigned long tmp;
  58   1        tmp = filter_time;
  59   1        //while(eeprom_write_byte(15, tmp & 0x000000ff) != 1);//如果写入的和读出的不一致就卡住
  60   1        //WDTCON = 0x10;
  61   1        //IAPWrite(0x0f,(unsigned char)tmp,IapEPPROM); 
  62   1        WDTCON = 0x10;
  63   1        eeprom_write_byte(15, tmp & 0x000000ff);
  64   1        //IAPWrite(0x0f,0x20,IapEPPROM); 
  65   1        
  66   1        tmp >>= 8;
  67   1        WDTCON = 0x10;
  68   1        eeprom_write_byte(14, tmp & 0x000000ff);
  69   1        tmp >>= 8;
  70   1        WDTCON = 0x10;
  71   1        eeprom_write_byte(13, tmp & 0x000000ff);
  72   1        tmp >>= 8;
  73   1        WDTCON = 0x10;
  74   1        eeprom_write_byte(12, tmp & 0x000000ff);
  75   1        
  76   1        
  77   1        
  78   1      }
  79          
  80          unsigned long read_filter_time(void)
  81          {
  82   1        unsigned long temp = 0;
  83   1        //temp = eeprom_read_byte(15);
  84   1        //WDTCON = 0x10;
  85   1        //temp = IAPRead(0x0f, IapEPPROM);
  86   1        
  87   1        WDTCON = 0x10;
  88   1        temp = eeprom_read_byte(12);
  89   1        temp <<= 8;
  90   1        WDTCON = 0x10;
  91   1        temp += eeprom_read_byte(13);
  92   1        temp <<= 8;
  93   1        WDTCON = 0x10;
  94   1        temp += eeprom_read_byte(14);
  95   1        temp <<= 8;
  96   1        WDTCON = 0x10;
  97   1        temp += eeprom_read_byte(15);
  98   1        //temp += IAPRead(0x0f, IapEPPROM);
  99   1        return temp;
 100   1      }
 101          
 102          
 103          
 104          void reset_filter_time(void)
 105          {
 106   1        
 107   1        WDTCON  = 0x10; 
 108   1        eeprom_write_byte(12, 0);
 109   1        WDTCON  = 0x10;
 110   1        eeprom_write_byte(13, 0);
 111   1        WDTCON  = 0x10;
 112   1        eeprom_write_byte(14, 0);
 113   1        WDTCON  = 0x10;
 114   1        eeprom_write_byte(15, 0);
 115   1        
 116   1        //t2 = IAPRead(0x71, IapEPPROM);
C51 COMPILER V9.52.0.0   FILTER                                                            10/19/2019 22:24:25 PAGE 3   

 117   1        
 118   1        /*
 119   1        IAPWrite(12,0x00,IapEPPROM); 
 120   1        WDTCON = 0x10;
 121   1        IAPWrite(13,0x00,IapEPPROM); 
 122   1        WDTCON  = 0x10; 
 123   1        IAPWrite(14,0x00,IapEPPROM); 
 124   1        WDTCON = 0x10;
 125   1        IAPWrite(15,0x00,IapEPPROM); 
 126   1        */
 127   1        filter_time = 0;
 128   1        filter_out_time_flag = 0;
 129   1        
 130   1      //  reset_led_flter_out_time();
 131   1      }
 132          
 133          
 134          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    510    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
