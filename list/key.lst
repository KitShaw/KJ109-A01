C51 COMPILER V9.52.0.0   KEY                                                               10/01/2019 16:08:22 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\obj\key.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\key.c BROWSE INCDIR(.\inc;.\lib) DEBUG OBJECTEXTEND PRINT(.\list\key.ls
                    -t) TABS(2) OBJECT(.\obj\key.obj)

line level    source

   1          
   2          
   3          /*
   4           * key.c
   5           */
   6          
   7          #include <key.h>
   8          #include "inc\SC92F844x_C.h"
   9          #include "data_type.h"
  10          #include "lib\SensorMethod.h"
  11          #include "fan.h"
  12          #include "led.h"
  13          #include "eeprom.h"
  14          #include "filter.h"
  15          //#include "IAP.h"
  16          
  17          
  18          bitval key_flag;
  19          
  20          #define KEY_POWER_FLAG  key_flag.bit0
  21          #define KEY_SPEED_FLAG  key_flag.bit1
  22          #define KEY_SLEEP_FLAG  key_flag.bit2
  23          #define KEY_NIGHT_LIGHT_FLAG  key_flag.bit3
  24          unsigned char key_power_count;
  25          unsigned short key_speed_count;
  26          unsigned char key_sleep_count;
  27          unsigned char key_night_light_count;
  28          
  29          INT32U exKeyValueFlag = 0;    //当前轮按键标志
  30          
  31          
  32          /**************************************************
  33          *函数名称：void  Sys_Scan(void) 
  34          *函数功能：扫描TK和显示
  35          *入口参数：void
  36          *出口参数：void  
  37          **************************************************/
  38          void Sys_Scan(void)
  39          {             
  40   1        if(SOCAPI_TouchKeyStatus&0x80)      //重要步骤2:  触摸键扫描一轮标志，是否调用TouchKeyScan()一定要根据此标
             -志位置起后
  41   1         {                                      
  42   2          SOCAPI_TouchKeyStatus &= 0x7f;  //重要步骤3: 清除标志位， 需要外部清除。                              
  43   2          exKeyValueFlag = TouchKeyScan();//按键数据处理函数    电源键是0x0800, 风速键是0x0400, 睡眠键是0x0200
  44   2          TouchKeyRestart();        //启动下一轮转换                                                                  
  45   2        }          
  46   1      }
  47          
  48          
  49          //0x0100--power
  50          //0x2000--香薰
  51          //0x1000--ion
  52          //0x0080--模式
  53          //0x0040--童锁
C51 COMPILER V9.52.0.0   KEY                                                               10/01/2019 16:08:22 PAGE 2   

  54          //0x0020--timer
  55          //0x31e0
  56          
  57          void key_task(void)       
  58          //按键任务, 1ms调用一次
  59          { 
  60   1        
  61   1        //if(read_over_voltage_flag() == 1) return;  //电压超过按键不处理直接返回
  62   1        if((exKeyValueFlag & 0x0000031e0) == 0x000000100)//电源键  //灵敏度不够
  63   1        {
  64   2          if(0 == KEY_POWER_FLAG)
  65   2          {
  66   3            if(++key_power_count >= 50)
  67   3            {
  68   4              KEY_POWER_FLAG = 1;
  69   4              key_power_com();        
  70   4            }
  71   3          }
  72   2        }
  73   1        else 
  74   1        {
  75   2          KEY_POWER_FLAG = 0;
  76   2          key_power_count = 0;
  77   2        }
  78   1        
  79   1        if((exKeyValueFlag & 0x000000f00) == 0x000000100)//夜灯键 
  80   1        {
  81   2          if(0 == KEY_NIGHT_LIGHT_FLAG)
  82   2          {
  83   3            if(++key_night_light_count >= 50)
  84   3            {
  85   4              KEY_NIGHT_LIGHT_FLAG = 1;
  86   4              key_night_light_com();
  87   4            }
  88   3          }
  89   2        }
  90   1        else 
  91   1        {
  92   2          KEY_NIGHT_LIGHT_FLAG = 0;
  93   2          key_night_light_count = 0;
  94   2        }
  95   1        
  96   1        if(read_power_status() == POWER_OFF_STATUS)return; //关机状态直接返回
  97   1        
  98   1        if((exKeyValueFlag & 0x000000f00) == 0x000000400)//风速键 
  99   1        {
 100   2          if(0 == KEY_SPEED_FLAG)
 101   2          {
 102   3            if(++key_speed_count >= 5000)
 103   3            {
 104   4              KEY_SPEED_FLAG = 1;
 105   4              key_speed_long_com();
 106   4            }
 107   3          }
 108   2        }
 109   1        else 
 110   1        {
 111   2          if((key_speed_count>50) && (key_speed_count< 5000))
 112   2          {
 113   3            key_speed_com();
 114   3          }
 115   2          KEY_SPEED_FLAG = 0;
C51 COMPILER V9.52.0.0   KEY                                                               10/01/2019 16:08:22 PAGE 3   

 116   2          key_speed_count = 0;
 117   2        }
 118   1        
 119   1        if((exKeyValueFlag & 0x000000f00) == 0x000000200)//睡眠键 
 120   1        {
 121   2          if(0 == KEY_SLEEP_FLAG)
 122   2          {
 123   3            if(++key_sleep_count >= 50)
 124   3            {
 125   4              KEY_SLEEP_FLAG = 1;
 126   4              key_sleep_com();
 127   4            }
 128   3          }
 129   2        }
 130   1        else 
 131   1        {
 132   2          KEY_SLEEP_FLAG = 0;
 133   2          key_sleep_count = 0;
 134   2        }
 135   1          
 136   1      }
 137          
 138          void key_night_light_com(void)
 139          {
 140   1        //night_light_level_handle();
 141   1        
 142   1      }
 143          
 144          
 145          void key_speed_com(void)
 146          {
 147   1        if(2 == read_fan_speed())set_fan_speed(1);
 148   1        else set_fan_speed(2);
 149   1        //if(flash_write_byte(10, 10) == 1)
 150   1        //led_key_speed();
 151   1      }
 152          
 153          void key_speed_long_com(void)
 154          //长按风速键清楚滤网寿命
 155          {
 156   1        reset_filter_time();
 157   1      }
 158          
 159          void key_sleep_com(void)
 160          { 
 161   1        P50 = ~P50;
 162   1        if(read_fan_speed() != 0) 
 163   1        {
 164   2          set_fan_speed(0);
 165   2          //set_night_light_level(0);
 166   2          //led_key_sleep();
 167   2        }
 168   1        else 
 169   1        {
 170   2          set_fan_speed(1);
 171   2          //led_key_speed();
 172   2        }
 173   1        
 174   1      }
 175          
 176          
 177          
C51 COMPILER V9.52.0.0   KEY                                                               10/01/2019 16:08:22 PAGE 4   

 178          void key_power_com(void)
 179          {
 180   1        //unsigned long filter_time_temp;
 181   1        if(POWER_ON_STATUS == read_power_status())
 182   1        {
 183   2          power_off();
 184   2          //if((read_filter_time()) & 0x000000ff == 0) led_power_on();
 185   2          
 186   2          //filter_time_temp = read_filter_time();
 187   2          //WDTCON  = 0x10;
 188   2          //IAPWrite(0x0f,(unsigned char)(filter_time_temp & 0x000000ff),IapEPPROM); 
 189   2          //IAPWrite(0x0f,0x20,IapEPPROM); 
 190   2          //IAPWrite(0x0f,31,IapEPPROM); 
 191   2          write_filter_time();
 192   2        }
 193   1        else
 194   1        {
 195   2          power_on();
 196   2        }
 197   1      }
 198          
 199          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    321    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     10    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
