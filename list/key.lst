C51 COMPILER V9.52.0.0   KEY                                                               10/08/2019 20:56:14 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\obj\key.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\key.c BROWSE INCDIR(.\inc;.\lib) DEBUG OBJECTEXTEND PRINT(.\list\key.ls
                    -t) TABS(2) OBJECT(.\obj\key.obj)

line level    source

   1          
   2          
   3          /*
   4           * key.c
   5           */
   6          
   7          #include <key.h>
   8          #include "inc\SC92F844x_C.h"
   9          #include "data_type.h"
  10          #include "lib\SensorMethod.h"
  11          #include "fan.h"
  12          #include "led.h"
  13          #include "eeprom.h"
  14          #include "filter.h"
  15          #include "ion.h"
  16          #include "arom.h"
  17          #include "timing_off.h"
  18          #include "beep.h"
  19          
  20          
  21          bitval key_flag;
  22          
  23          #define KEY_POWER_FLAG  key_flag.bit0
  24          #define KEY_AROM_FLAG key_flag.bit1   
  25          #define KEY_SPEED_FLAG  key_flag.bit2
  26          #define KEY_LOCK_FLAG key_flag.bit3
  27          #define LOCK_FLAG   key_flag.bit6            //童锁解锁标志, 0解锁, 1锁住
  28          #define KEY_ION_FLAG key_flag.bit4
  29          #define KEY_TIMER_FLAG key_flag.bit5
  30          
  31          unsigned short key_power_count;
  32          unsigned short key_speed_count;
  33          unsigned short key_lock_count;
  34          unsigned short key_ion_count;
  35          unsigned short key_timer_count;
  36          unsigned short key_arom_count;
  37          
  38          unsigned long xdata key_no_move_count;      //按键没要按下计数, 如果一分钟没有动作,童锁就锁住
  39          
  40          
  41          INT32U exKeyValueFlag = 0;    //当前轮按键标志
  42          
  43          
  44          /**************************************************
  45          *函数名称：void  Sys_Scan(void) 
  46          *函数功能：扫描TK和显示
  47          *入口参数：void
  48          *出口参数：void  
  49          **************************************************/
  50          void Sys_Scan(void)
  51          {             
  52   1        if(SOCAPI_TouchKeyStatus&0x80)      //重要步骤2:  触摸键扫描一轮标志，是否调用TouchKeyScan()一定要根据此标
             -志位置起后
  53   1         {                                      
C51 COMPILER V9.52.0.0   KEY                                                               10/08/2019 20:56:14 PAGE 2   

  54   2          SOCAPI_TouchKeyStatus &= 0x7f;  //重要步骤3: 清除标志位， 需要外部清除。                              
  55   2          exKeyValueFlag = TouchKeyScan();//按键数据处理函数    
  56   2          if((exKeyValueFlag & 0x0000031e0) != 0)reset_key_no_move_count(); //有键按下就复位按键计数值
  57   2          TouchKeyRestart();        //启动下一轮转换                                                                  
  58   2        }          
  59   1      }
  60          
  61          void key_init(void)
  62          {
  63   1        LOCK_FLAG = 0;  
  64   1        reset_key_no_move_count();
  65   1      }
  66          
  67          void reset_key_no_move_count(void)
  68          {
  69   1        key_no_move_count = 0;
  70   1      }
  71          
  72          //0x0100--power
  73          //0x2000--香薰
  74          //0x1000--ion
  75          //0x0080--模式
  76          //0x0040--童锁
  77          //0x0020--timer
  78          //0x31e0
  79          
  80          void key_task(void)       
  81          //按键任务, 1ms调用一次
  82          { 
  83   1        if(key_no_move_count >= 180000)
  84   1        {
  85   2          LOCK_FLAG = 1; 
  86   2        }
  87   1        else
  88   1        {
  89   2          //reset_key_no_move_count();
  90   2          key_no_move_count++;
  91   2        }
  92   1      
  93   1        if(((exKeyValueFlag & 0x0000031e0) == 0x000000100) && (0 == LOCK_FLAG))//电源键  //灵敏度不够
  94   1        {
  95   2          if(0 == KEY_POWER_FLAG)
  96   2          {     
  97   3            if(++key_power_count >= 5000)
  98   3            {
  99   4              KEY_POWER_FLAG = 1;   
 100   4              key_power_long_com();
 101   4            }
 102   3          }
 103   2        }
 104   1        else 
 105   1        {
 106   2        
 107   2          if((key_power_count>5) && (key_power_count< 5000))
 108   2          {
 109   3            key_power_com();
 110   3          }
 111   2          
 112   2          KEY_POWER_FLAG = 0;
 113   2          key_power_count = 0;
 114   2        }
 115   1        
C51 COMPILER V9.52.0.0   KEY                                                               10/08/2019 20:56:14 PAGE 3   

 116   1        
 117   1        
 118   1        if(read_power_status() == POWER_OFF_STATUS)return; //关机状态直接返回
 119   1        
 120   1        if(((exKeyValueFlag & 0x0000031e0) == 0x000000080) && (0 == LOCK_FLAG))//风速键 
 121   1        {
 122   2          if(0 == KEY_SPEED_FLAG)
 123   2          {
 124   3            if(++key_speed_count >= 50)
 125   3            {
 126   4              KEY_SPEED_FLAG = 1;
 127   4              key_speed_com();
 128   4            }
 129   3          }
 130   2        }
 131   1        else 
 132   1        {
 133   2      //    if((key_speed_count>5) && (key_speed_count< 5000))
 134   2      //    {
 135   2      //      key_speed_com();
 136   2      //    }
 137   2          KEY_SPEED_FLAG = 0;
 138   2          key_speed_count = 0;
 139   2        }
 140   1        
 141   1        if(((exKeyValueFlag & 0x0000031e0) == 0x000001000) && (0 == LOCK_FLAG))//ion
 142   1        {
 143   2          if(0 == KEY_ION_FLAG)
 144   2          {
 145   3            if(++key_ion_count >= 10)
 146   3            {
 147   4              KEY_ION_FLAG = 1;
 148   4              key_ion_com();        
 149   4            }
 150   3          }
 151   2        }
 152   1        else 
 153   1        {
 154   2          KEY_ION_FLAG = 0;
 155   2          key_ion_count = 0;
 156   2        }
 157   1        
 158   1        if(((exKeyValueFlag & 0x0000031e0) == 0x000002000) && (0 == LOCK_FLAG))//arom
 159   1        {
 160   2          if(0 == KEY_AROM_FLAG)
 161   2          {
 162   3            if(++key_arom_count >= 10)
 163   3            {
 164   4              KEY_AROM_FLAG = 1;
 165   4              key_arom_com();       
 166   4            }
 167   3          }
 168   2        }
 169   1        else 
 170   1        {
 171   2          KEY_AROM_FLAG = 0;
 172   2          key_arom_count = 0;
 173   2        }
 174   1          
 175   1        if((exKeyValueFlag & 0x0000031e0) == 0x000000040)//
 176   1        {
 177   2          if(0 == KEY_LOCK_FLAG)
C51 COMPILER V9.52.0.0   KEY                                                               10/08/2019 20:56:14 PAGE 4   

 178   2          {
 179   3            if(++key_lock_count >= 5000)
 180   3            {
 181   4              KEY_LOCK_FLAG = 1;
 182   4              //set_beep_count(10);
 183   4              key_lock_com();       
 184   4            }
 185   3          }
 186   2        }
 187   1        else 
 188   1        {
 189   2          KEY_LOCK_FLAG = 0;
 190   2          key_lock_count = 0;
 191   2        }
 192   1        if(((exKeyValueFlag & 0x0000031e0) == 0x000000020) && (0 == LOCK_FLAG))//
 193   1        {
 194   2          if(0 == KEY_TIMER_FLAG)
 195   2          {
 196   3            if(++key_timer_count >= 10)
 197   3            {
 198   4              KEY_TIMER_FLAG = 1;
 199   4              key_timer_com();        
 200   4            }
 201   3          }
 202   2        }
 203   1        else 
 204   1        {
 205   2          KEY_TIMER_FLAG = 0;
 206   2          key_timer_count = 0;
 207   2        }
 208   1      }
 209          
 210          void key_ion_com(void)
 211          {
 212   1        ION_PIN = !ION_PIN;
 213   1        set_beep_count(10);
 214   1      }
 215          
 216          void reset_lock_flag(void)
 217          {
 218   1        LOCK_FLAG = 0;
 219   1        reset_key_no_move_count();
 220   1        set_beep_count(10);
 221   1      }
 222          
 223          void key_timer_com(void)
 224          {
 225   1        regulate_timing_off_level();
 226   1        set_beep_count(10);
 227   1      }
 228          
 229          void key_arom_com(void)
 230          {
 231   1        regulate_arom_level();
 232   1        set_beep_count(10);
 233   1      }
 234          
 235          void key_lock_com(void)
 236          {
 237   1        //P52 = ~P52;
 238   1        //UNLOCk_FLAG = ~UNLOCk_FLAG;
 239   1        //LOCK_FLAG = ~LOCK_FLAG;      //解
C51 COMPILER V9.52.0.0   KEY                                                               10/08/2019 20:56:14 PAGE 5   

 240   1        reset_lock_flag();  
 241   1        
 242   1      }
 243          
 244          bit read_unlock_flag(void)
 245          {
 246   1        return LOCK_FLAG;
 247   1      }
 248          
 249          void key_speed_com(void)
 250          {
 251   1        regulate_fan_speed();
 252   1        set_beep_count(10);
 253   1        
 254   1      }
 255          
 256          void key_power_long_com(void)
 257          //长按电源键清楚滤网寿命
 258          {
 259   1        reset_filter_time();
 260   1        set_beep_count(10);
 261   1      }
 262          
 263          //void key_sleep_com(void)
 264          //{ 
 265          //  P50 = ~P50;
 266          //  if(read_fan_speed() != 0) 
 267          //  {
 268          /////   set_fan_speed(0);
 269          //    //set_night_light_level(0);
 270          //    //led_key_sleep();
 271          //  }
 272          //  else 
 273          //  {
 274          ////    set_fan_speed(1);
 275          //    //led_key_speed();
 276          //  }
 277          //  
 278          //}
 279          
 280          
 281          
 282          void key_power_com(void)
 283          {
 284   1        //unsigned long filter_time_temp;
 285   1        //P50 = ~P50;
 286   1        set_beep_count(10);
 287   1        if(POWER_ON_STATUS == read_power_status())
 288   1        {
 289   2          power_off();
 290   2          //if((read_filter_time()) & 0x000000ff == 0) led_power_on();
 291   2          
 292   2          //filter_time_temp = read_filter_time();
 293   2          //WDTCON  = 0x10;
 294   2          //IAPWrite(0x0f,(unsigned char)(filter_time_temp & 0x000000ff),IapEPPROM); 
 295   2          //IAPWrite(0x0f,0x20,IapEPPROM); 
 296   2          //IAPWrite(0x0f,31,IapEPPROM); 
 297   2          write_filter_time();
 298   2        }
 299   1        else
 300   1        {
 301   2          power_on();
C51 COMPILER V9.52.0.0   KEY                                                               10/08/2019 20:56:14 PAGE 6   

 302   2        }
 303   1      }
 304          
 305          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    636    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     17    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
