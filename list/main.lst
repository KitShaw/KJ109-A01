C51 COMPILER V9.52.0.0   MAIN                                                              09/30/2019 22:24:01 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\obj\main.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\main.c BROWSE INCDIR(.\inc;.\lib) DEBUG OBJECTEXTEND PRINT(.\list\main.
                    -lst) TABS(2) OBJECT(.\obj\main.obj)

line level    source

   1           //************************************************************
   2          //  Copyright (c) 厦门市凯杰斯科技有限公司
   3          //  文件名称  : main.c
   4          //  作者    : 
   5          //  模块功能  : 
   6          //  最后更正日期:
   7          //  版本    : 
   8          //              :  
   9          //*************************************************************
  10          #include "inc\SC92F844X_C.h"
  11          #include "inc\data_type.h"
  12          #include "lib\SensorMethod.h"
  13          #include "led.h"
  14          #include "fan.h"
  15          #include "key.h"
  16          #include "eeprom.h"
  17          #include "filter.h"
  18          //#include "IAP.h"
  19          #include "ion.h"
  20          
  21          // KJ60F-A3是SC92F8372单片机加自己的板子, 和原样的板子相比改了,LED改成6个口各单独控制一个LED, 
  22          
  23          //*****************全局变量区***************************************************
  24          
  25          INT8U  Timercount = 0;      //定时器计数
  26          BOOL   TimerFlag_1ms = 0;   //定时器1MS标志
  27          
  28          //unsigned char power_status = POWER_OFF_STATUS;
  29          unsigned char led_level = 0;
  30          unsigned char speed_level = 0;
  31          unsigned char task_1s_count;
  32          unsigned char task_1s_flag;
  33          
  34          unsigned char task_100ms_count;
  35          unsigned char task_100ms_flag;
  36          
  37          
  38          
  39           /**************************************************
  40          *函数名称：void TimerInit(void) 
  41          *函数功能：定时器初始化
  42          *入口参数：void
  43          *出口参数：void
  44          **************************************************/
  45          void TimerInit(void)
  46          {
  47   1        TMCON = (TMCON&0xfe)|(0<<0);    //bit0: 0为FOSC/12,1为FOSO
  48   1      
  49   1        TMOD = TMOD&0xf0;           //设置定时0，工作方式0
  50   1        TMOD = TMOD|0x00;
  51   1        TH0=(8192-1000)/32;             //1000*1=1000us ,1MS
  52   1        TL0=(8192-1000)%32;
  53   1        TF0 = 0;                //清中断标志
  54   1        TR0=0;                //关定时器0
C51 COMPILER V9.52.0.0   MAIN                                                              09/30/2019 22:24:01 PAGE 2   

  55   1          ET0=1;                //使能定时器0中断
  56   1        TR0=1;
  57   1      }
  58          
  59          /**************************************************
  60          *函数名称：void timer0()interrupt 1 
  61          *函数功能：定时器中断服务函数
  62          *入口参数：void
  63          *出口参数：void 
  64          **************************************************/
  65          void timer0()interrupt 1
  66          {
  67   1        TH0 = (8192-1000)/32;             //2000*1/4us=500us
  68   1        TL0 = (8192-1000)%32; 
  69   1        TimerFlag_1ms = 1;  
  70   1        led_task();
  71   1        night_light_task();
  72   1      }
  73           /**************************************************
  74          *函数名称：void  Sys_Init(void) 
  75          *函数功能：系统初始化
  76          *入口参数：void
  77          *出口参数：void  
  78          **************************************************/
  79          void  Sys_Init(void)
  80          { 
  81   1        WDTCON  = 0x10;           //1--1 -- 00    开WDT,WDT清0,WDT 524.288ms溢出;烧录时，可Code Option选择ENWDT
  82   1        //TK对应的IO设置为强推挽输出1
  83   1        P0CON = 0xFF;
  84   1        P0PH  = 0x40; 
  85   1        P1CON = 0xFF;
  86   1        P1PH  = 0x1f;
  87   1        
  88   1        P2CON = 0xFE;  //P2.4(night light), P2.5(sleep), P2.6(speed), P2.7(power)是触摸脚 
  89   1        P2PH  = 0xF1;  //P2.0是输入脚, 电压超过15V时是高电平, 正常工作时是低电平,
  90   1      
  91   1        P0 = 0xFF;
  92   1        P1 = 0xFF;
  93   1        P2 = 0xFF;
  94   1             
  95   1        led_init();
  96   1        EA = 1;           //开总中断  
  97   1          TimerInit();        //定时器初始化
  98   1        
  99   1        power_off();
 100   1      }
 101          
 102          void task_100ms(void)
 103          {
 104   1        if(++task_1s_count>=10){task_1s_count = 0; task_1s_flag = 1; }
 105   1        filter_task();
 106   1        
 107   1      }
 108          
 109          void task_1s(void)
 110          {
 111   1        //filter_task();
 112   1      }
 113          
 114          /**************************************************
 115          *函数名称：void main(void)                  
 116          *函数功能：主函数
C51 COMPILER V9.52.0.0   MAIN                                                              09/30/2019 22:24:01 PAGE 3   

 117          *入口参数：void
 118          *出口参数：void  
 119          **************************************************/
 120          void main(void)
 121          {     
 122   1        Sys_Init();
 123   1        
 124   1        //触控按键初始化
 125   1        TouchKeyInit(); 
 126   1        //fan_init();
 127   1        //eeprom_init();
 128   1      
 129   1        //filter_init();
 130   1        //ion_init();
 131   1        
 132   1        while(1)
 133   1        {
 134   2           WDTCON  = 0x10;             
 135   2           if(TimerFlag_1ms==1)
 136   2           {
 137   3            TimerFlag_1ms=0;  
 138   3            Timercount++;
 139   3            if(++task_100ms_count>=100){task_100ms_count = 0; task_100ms_flag = 1;}
 140   3            if(Timercount>10)
 141   3            {
 142   4              Timercount=0;
 143   4              Sys_Scan();       
 144   4            }
 145   3              key_task();           
 146   3           }
 147   2           over_voltage_handle();   
 148   2            if(1 == task_100ms_flag) {task_100ms_flag = 0; task_100ms(); }
 149   2            if(1 == task_1s_flag) {task_1s_flag = 0; task_1s();}
 150   2        } 
 151   1      }
 152          
 153          
 154          
 155          
 156          
 157          
 158          
 159          
 160          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    228    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
