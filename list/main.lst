C51 COMPILER V9.52.0.0   MAIN                                                              10/04/2019 19:46:48 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\obj\main.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\main.c BROWSE INCDIR(.\inc;.\lib) DEBUG OBJECTEXTEND PRINT(.\list\main.
                    -lst) TABS(2) OBJECT(.\obj\main.obj)

line level    source

   1           //************************************************************
   2          //  Copyright (c) 厦门市凯杰斯科技有限公司
   3          //  文件名称  : main.c
   4          //  作者    : 
   5          //  模块功能  : 
   6          //  最后更正日期:
   7          //  版本    : 
   8          //              :  
   9          //*************************************************************
  10          #include "inc\SC92F844X_C.h"
  11          #include "inc\data_type.h"
  12          #include "lib\SensorMethod.h"
  13          #include "led.h"
  14          #include "fan.h"
  15          #include "key.h"
  16          #include "eeprom.h"
  17          #include "filter.h"
  18          //#include "IAP.h"
  19          #include "ion.h"
  20          #include "dust.h"
  21          //#include "display.h"
  22          
  23          // KJ60F-A3是SC92F8372单片机加自己的板子, 和原样的板子相比改了,LED改成6个口各单独控制一个LED, 
  24          
  25          //*****************全局变量区***************************************************
  26          
  27          INT8U  Timercount = 0;      //定时器计数
  28          BOOL   TimerFlag_1ms = 0;   //定时器1MS标志
  29          
  30          //unsigned char power_status = POWER_OFF_STATUS;
  31          //unsigned char led_level = 0;
  32          //unsigned char speed_level = 0;
  33          unsigned int fan_count_1s;
  34          unsigned char task_1s_count;
  35          unsigned char task_1s_flag;
  36          
  37          unsigned char task_100ms_count;
  38          unsigned char task_100ms_flag;
  39          unsigned char task_10ms_count;
  40          unsigned char task_10ms_flag;
  41          unsigned char task_1ms_count;
  42          unsigned char task_1ms_flag;
  43          unsigned char dust_count;
  44          
  45          void task_1ms(void);
  46          void task_10ms(void);
  47          void task_100ms(void);
  48          void task_1s(void);
  49          void timer1_start(void);
  50          
  51          
  52          
  53          
  54           /**************************************************
C51 COMPILER V9.52.0.0   MAIN                                                              10/04/2019 19:46:48 PAGE 2   

  55          *函数名称：void TimerInit(void) 
  56          *函数功能：定时器初始化
  57          *入口参数：void
  58          *出口参数：void
  59          **************************************************/
  60          void TimerInit(void)
  61          {
  62   1        TMCON |= 0X02;
  63   1        TMOD |= 0x10;            
  64   1        TL1 = (65536 - 1600)%256;  
  65   1        TH1 = (65536 - 1600)/256; 
  66   1        TR1 = 0;
  67   1        ET1 = 1;//
  68   1        
  69   1        TMCON |= 0X01;    //------111 ;Timer0、Tiemr1和Tiemr2选择时钟Fsys
  70   1        
  71   1        
  72   1        //T0设置
  73   1        TMOD |= 0x01;                 //0000 0001;Timer0设置工作方式1
  74   1        TL0 = (65536 - 1600)%256;    //溢出时间：时钟为Fsys，则16000*（1/Fsys）=1ms;
  75   1        TH0 = (65536 - 1600)/256;
  76   1        TR0 = 0;
  77   1        ET0 = 1;//定时器0允许
  78   1        TR0 = 1;//打开定时器0
  79   1      
  80   1          //IP |= (1<<1) | (1<<5);      //定时1, 和0高优先级
  81   1          IP &= ~((1<<1) | (1<<5));      //定时1, 和0高优先级
  82   1      }
  83          
  84          void timer1_start(void)
  85          {
  86   1        TL1 = (65536 - 4480)%256;    //240s
  87   1        TH1 = (65536 - 4480)/256;    //236.9375
  88   1        TR1 = 1;
  89   1      }
  90          /**************************************************
  91          *函数名称：void timer0()interrupt 1 
  92          *函数功能：定时器中断服务函数
  93          *入口参数：void
  94          *出口参数：void 
  95          **************************************************/
  96          void timer0()interrupt 1
  97          {
  98   1        TL0 = 50; //(65536 - 1600)%256 = 192;    //溢出时间：时钟为Fsys，则16000*（1/Fsys）=1ms;
  99   1        TH0 = 250; //(65536 - 1600)/256 = 249;
 100   1        if( dust_count == 4) DUST_PIN = 1;
 101   1        else if(dust_count >= 100){
 102   2          DUST_PIN = 0; 
 103   2          dust_count = 0;
 104   2          timer1_start();   
 105   2        }
 106   1        dust_count++;
 107   1        if(++task_1ms_count >= 10) {task_1ms_flag = 1; task_1ms_count = 0;}
 108   1        //if(++fan_count_1s >= 10000) { fan_count_1s = 0; store_fan_return_pulse();}  //电机计数1秒的脉冲用
 109   1      }
 110           /**************************************************
 111          *函数名称：void  Sys_Init(void) 
 112          *函数功能：系统初始化
 113          *入口参数：void
 114          *出口参数：void  
 115          **************************************************/
 116          void  Sys_Init(void)
C51 COMPILER V9.52.0.0   MAIN                                                              10/04/2019 19:46:48 PAGE 3   

 117          { 
 118   1        WDTCON  = 0x10;           //1--1 -- 00    开WDT,WDT清0,WDT 524.288ms溢出;烧录时，可Code Option选择ENWDT
 119   1        //TK对应的IO设置为强推挽输出1
 120   1        
 121   1        P1CON |= (1<<0) | (1<<4) | (1<<5);                //P10, P14, P15是触摸脚
 122   1        P3CON |= (1<<0) | (1<<1) | (1<<20);
 123   1        led_init();
 124   1        //display_init();
 125   1        dust_init();
 126   1        EA = 1;           //开总中断  
 127   1          TimerInit();        //定时器初始化
 128   1        fan_init();
 129   1        ion_init();
 130   1        //触控按键初始化
 131   1        TouchKeyInit(); 
 132   1        key_init(); 
 133   1        eeprom_init();
 134   1        filter_init();
 135   1        power_on();
 136   1      }
 137          void task_1ms(void)
 138          {
 139   1        //filter_task();
 140   1        key_task(); 
 141   1        if(++task_10ms_count>=10) {task_10ms_count = 0; task_10ms_flag = 1;}
 142   1        //P52=~P52;
 143   1      }
 144          
 145          void task_10ms(void)
 146          {
 147   1        //filter_task();
 148   1        
 149   1        Sys_Scan();   
 150   1        led_task();
 151   1        if(++task_100ms_count>=10){task_100ms_count = 0; task_100ms_flag = 1;}
 152   1        //P52=~P52;
 153   1        dust_task();
 154   1        
 155   1      }
 156          
 157          void task_100ms(void)
 158          {
 159   1        if(++task_1s_count>=10){task_1s_count = 0; task_1s_flag = 1; }
 160   1        filter_task();
 161   1        fan_task();
 162   1      }
 163          
 164          void task_1s(void)
 165          {
 166   1        //filter_task();
 167   1        //P52=~P52;
 168   1      }
 169          
 170          /**************************************************
 171          *函数名称：void main(void)                  
 172          *函数功能：主函数
 173          *入口参数：void
 174          *出口参数：void  
 175          **************************************************/
 176          void main(void)
 177          {     
 178   1        Sys_Init();
C51 COMPILER V9.52.0.0   MAIN                                                              10/04/2019 19:46:48 PAGE 4   

 179   1        //ion_init();
 180   1        //DUST_PWR_PIN = 0;
 181   1        while(1)
 182   1        {
 183   2           WDTCON  = 0x10;     
 184   2            if(1 == task_1ms_flag) { task_1ms_flag = 0; task_1ms();}
 185   2            if(1 == task_10ms_flag) { task_10ms_flag = 0; task_10ms();}
 186   2            if(1 == task_100ms_flag) {task_100ms_flag = 0; task_100ms(); }
 187   2            if(1 == task_1s_flag) {task_1s_flag = 0; task_1s();}
 188   2        } 
 189   1      }
 190          
 191          
 192          /**************************************************
 193          *函数名称：void timer1()interrupt 1 
 194          *函数功能：定时器中断服务函数
 195          *入口参数：void
 196          *出口参数：void 
 197          **************************************************/
 198          void timer1()interrupt 3
 199          {
 200   1        TR1 = 0;
 201   1        adc_start();
 202   1        //P52 =~P52;
 203   1      }
 204          
 205          
 206          
 207          
 208          
 209          
 210          
 211          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    322    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
